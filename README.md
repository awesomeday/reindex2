Для переиндексации используется Reindex API https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html

1. Запускается переиндексация в фоновом режиме (с флагом wait_for_completion=true)
То есть создается новый индекс с новыми настройками и в него переливаются статьи из старого.

2. Когда переиндексация завершена, сначала для нового индекса вызывается {indexName}/_forcemerge.
в принципе, эластик и сам это сделает в определенный момент, но для старых (по дате) индексов это может и не произойти, т.к. статьи туда больше не пишутся, значит размер не меняется и эластик не триггерит оптимизацию.

3. Затем старый индекс удаляется и для нового создается алиас, указывающий на старое имя. Это происходит одной атомарной операцией.

Темплейт для нового индекса берется из файла tmplt.txt, который должен лежать рядом с исполняемым файлом программы.

За текущим статусом программа следит через АПИ "_tasks" https://www.elastic.co/guide/en/elasticsearch/reference/current/tasks.html

Задачи переиндексации равномерно распределяются по нодам. Максимальное количество задач на ноду регулируется параметром maxTasksPerHost.

Программа не зависит от текущего состояния, то есть ее можно запустить, дождаться распределения задач по нодам и закрыть, затем открыть в любой момент.

Для перестраховки, перед удалением индекса проверяется, все ли статьи скопировались в новый индекс. Если по какой-то причине нет, то такому индексу ставится статус "Inconsistent", и удаления не происходит. Если на самом деле все ок (бывает, несколько документов не копируются по какой-то причине), можно просто отключить эту проверку и перезапустить прогармму.


Внутри Reindex API использует Scroll API, то есть в момент начала переиндексации делается "снепшот" текущего состояния. Если переиндексация делается для относительно недавней даты, то в процессе в старом индексе могут появиться статьи, которые не попадут в новый индекс. Тогда такому индексу тоже поставится статус "Inconsistent". В таком случае можно например так же отключив проверку, запустить прогармму, чтобы она удалила старый индекс и создала алиас, а затем дополнить новый индекс, воспользовавшись CMD командой ensure-elastic-completeness.